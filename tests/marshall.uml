let
    import "std.uh"
    import "list.uh"
    import "string.uh"
    import "int.uh"
    import "array.uh"
    import "char.uh"
    import "growarray.uh"
    import "marshall.uh"

    val ws = { readbuffer = {| chr 0, chr 0, chr 0, chr 0, chr 0, chr 0, chr 0, chr 0 |},
    	       writebuffer = growarray-new (chr 0),
	       byte_offset = 0,
	       bit_offset = 0 }

    val ws = writeNextInteger(ws, 4, 0, 0xdeadbeef)
    val ws = writeNextInteger(ws, 1, 0, 0x69)
    val ws = writeNextInteger(ws, 2, 0, 0x102)
    val ws = writeNextInteger(ws, 2, 0, 0xffaa)
    val ws = writeNextInteger(ws, 0, 4, 0xa)
    val ws = writeNextInteger(ws, 0, 4, 0x5)
    val ws = writeNextInteger(ws, 0, 4, 0xc)
    val ws = writeNextInteger(ws, 0, 4, 0xd)
    val ws = writeNextInteger(ws, 2, 0, 0xbbcc)

    val () = print [result = [chars-tohexstring (growarray-array (#writebuffer/marshall_type ws))]\n] 

    val s = { readbuffer = {| chr 69, chr 1, chr 2, chr 0xa5 |},
    	      writebuffer = growarray-new (chr 0),
    	      byte_offset = 0,
	      bit_offset = 0 }

    val (i1, s) = readNextInteger(s, 1, 0)
    val (i2, s) = readNextInteger(s, 2, 0)
    val (i3, s) = readNextInteger(s, 0, 2)
    val (i4, s) = readNextInteger(s, 0, 4)

in
    print [hi marshall! [int-tostring i1], [int-tostring i2], [int-tostring i3], [int-tostring i4]\n]
end
