let
    import "std.uh"
    import "list.uh"
    import "string.uh"
    import "int.uh"
    import "array.uh"
    import "char.uh"
    import "growarray.uh"
    import "clock.uh"
    import "map.uh"
    import "marshall.uh"
    import "ams-pkts.uh"
    import "ams-states.uh"
    import "ams.uh"
    import "descriptorio.uh"
    import "socket.uh"
    import "threads.uh"
    import "queues.uh"
    import "messagequeues.uh"
    import "futures.uh"
    import "activeobject.uh"

    fun AAMSSender ds = 
        let
            val hs = chars-tohexstring ds
        in
            print [AAMS Sender: [hs]\n]
        end

    fun MAMSSender ds = 
        let
            val hs = chars-tohexstring ds
        in
            print [MAMS Sender: [hs]\n]
        end

    val cs = { mams_endpoint_name = "udp=127.0.0.1:6969",
               delivery_vector_list = {| { delivery_vector_num = 1,
                                           number_delivery_point_names = 1,
                                           delivery_point_names = "udp=127.0.0.1:6970" } |} }

    val initial_state = { app_name = "myapp",
                          auth_name = "myauth",
                          aams_sender = AAMSSender,
                          mams_sender = MAMSSender,
                          contact_summary = cs,
                          subscriptions = nil,
                          subject_to_nodes_map = map-create (fn desiredk (k1, d1) => desiredk = k1),
                          node_to_contact_summary_map = map-create (fn desiredk (k1, d1) => desiredk = k1), 
                          node_id = 1001,
                          query_number = 0,
                          role = 1,
                          state = MAMS_WAITING_FOR_YOU_ARE_IN,
                          unit = 1,
                          last_registrar_hb_time = clock-gettime (),
                          registrar_dead = true,
                          venture = 1 }
 
    val ams = activeobject-create ams-process-function initial_state

    val hbs = array-map chr {| 0x01, 0x01, 0x00, 0x01, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xaa, 0x00, 0x00, 0x00, 0x00 |}

in
    ( future-force (ams (AMSRegister ("app", "auth", (* unit *) 1, (* role *) 100))) ;
      future-force (ams (AMSInboundMAMS hbs)) ;
      future-force (ams (AMSUnregister (* node id *) 9)) ;
      print "hi" )
end
