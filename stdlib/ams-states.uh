val provide-ams-states = ()
 
datatype MAMS_state_type =
     MAMS_WAITING_FOR_REGISTRAR
   | MAMS_REGISTRAR_KNOWN
   | MAMS_WAITING_FOR_YOU_ARE_IN
   | MAMS_YOU_ARE_IN
 
type ams-statetype =
    {
        aams_sender : (string -> string -> unit),
        message_callback : string -> unit,
        app_name : string,
        state : MAMS_state_type,
        registration_callback : int -> unit,
        subscriptions : subscription_assert_type list,
        node_to_contact_summary_map : (int, contact_summary_type) map,
        desired_transport : string,
        auth_name : string,
        contact_summary : contact_summary_type,
        node_id : int,
        role : int,
        subject_to_nodes_map : (int, (int * subscription_assert_type) list) map,
        venture : int,
        query_number : int,
        last_registrar_hb_time : int * int,
        registrar_dead : bool,
        mams_sender : (string -> string -> unit),
        unit : int,
        node_to_heartbeat_map : (int, int) map
    }

datatype ams-optype =
    aams_sender of (string -> string -> unit) |
    message_callback of string -> unit |
    app_name of string |
    state of MAMS_state_type |
    registration_callback of int -> unit |
    subscriptions of subscription_assert_type list |
    node_to_contact_summary_map of (int, contact_summary_type) map |
    desired_transport of string |
    auth_name of string |
    contact_summary of contact_summary_type |
    node_id of int |
    role of int |
    subject_to_nodes_map of (int, (int * subscription_assert_type) list) map |
    venture of int |
    query_number of int |
    last_registrar_hb_time of int * int |
    registrar_dead of bool |
    mams_sender of (string -> string -> unit) |
    unit of int |
    node_to_heartbeat_map of (int, int) map

fun ams-update-state tv st =
    case tv of 
        aams_sender v => {
            aams_sender = v,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | message_callback v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = v,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | app_name v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = v,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | state v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = v,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | registration_callback v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = v,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | subscriptions v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = v,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | node_to_contact_summary_map v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = v,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | desired_transport v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = v,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | auth_name v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = v,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | contact_summary v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = v,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | node_id v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = v,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | role v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = v,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | subject_to_nodes_map v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = v,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | venture v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = v,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | query_number v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = v,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | last_registrar_hb_time v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = v,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | registrar_dead v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = v,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | mams_sender v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = v,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | unit v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = v,
            node_to_heartbeat_map = #node_to_heartbeat_map/ams-statetype st
         }
        | node_to_heartbeat_map v => {
            aams_sender = #aams_sender/ams-statetype st,
            message_callback = #message_callback/ams-statetype st,
            app_name = #app_name/ams-statetype st,
            state = #state/ams-statetype st,
            registration_callback = #registration_callback/ams-statetype st,
            subscriptions = #subscriptions/ams-statetype st,
            node_to_contact_summary_map = #node_to_contact_summary_map/ams-statetype st,
            desired_transport = #desired_transport/ams-statetype st,
            auth_name = #auth_name/ams-statetype st,
            contact_summary = #contact_summary/ams-statetype st,
            node_id = #node_id/ams-statetype st,
            role = #role/ams-statetype st,
            subject_to_nodes_map = #subject_to_nodes_map/ams-statetype st,
            venture = #venture/ams-statetype st,
            query_number = #query_number/ams-statetype st,
            last_registrar_hb_time = #last_registrar_hb_time/ams-statetype st,
            registrar_dead = #registrar_dead/ams-statetype st,
            mams_sender = #mams_sender/ams-statetype st,
            unit = #unit/ams-statetype st,
            node_to_heartbeat_map = v
         }

